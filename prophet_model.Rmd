---
title: "prophet_model"
author: "Kartik Garg"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, warning=FALSE, message=FALSE}
library(TSA, warn.conflicts = FALSE)
library(forecast)
library(Metrics)
library(tseries)
library(dplyr)
library(prophet)
```

## Prophet Model on Tetuan City power consumption

```{r}
df <- read.csv("Tetuan City power consumption.csv")
head(df)
```

### Data Split into train and test sets

```{r}
df$DateTime <- as.POSIXct(df$DateTime,format="%m/%d/%Y %H:%M")
df2<-df[df$DateTime >= "2017-01-01" & df$DateTime < "2017-12-01",]
df2<-df2[complete.cases(df2), ]
history <- data.frame(ds = df2$DateTime, y = df2$Zone.1.Power.Consumption)
tail(history)
```

```{r}
test <- df[df$DateTime >= "2017-12-01",]
test<-test[complete.cases(test), ]
```

### Building prophet model with varying seasonalities

#### Daily

```{r}
m <- prophet(history, weekly.seasonality = F, yearly.seasonality = F)
```

Here we will make predictions for 2017 December

Plotting the predictions

```{r}
future = make_future_dataframe(m, periods = 4320, freq = 600)
forecast = predict(m, future)
plot(m, forecast, type="l")
```

```{r}
future_preds <- tail(forecast, 4320)
```

```{r}
pred_df <- data.frame(hours=test$DateTime, test_val=test$Zone.1.Power.Consumption, pred_val=future_preds$yhat)
d<- melt(pred_df, id.vars = "hours")

ggplot(d, aes(x=hours, y=value, color=variable)) + 
  geom_point(size=1) + 
  geom_line()
```

Checking smape for our model

```{r}
smape(test$Zone.1.Power.Consumption, future_preds$yhat)
```

#### Weekly

```{r}
m <- prophet(history, daily.seasonality = F, yearly.seasonality = F )
```

Here we will make predictions for 2017 December

Plotting the predictions

```{r}
future = make_future_dataframe(m, periods = 4320, freq = 600)
forecast = predict(m, future)
plot(m, forecast, type="l")
```

```{r}
future_preds <- tail(forecast, 4320)
```

```{r}
pred_df <- data.frame(hours=test$DateTime, test_val=test$Zone.1.Power.Consumption, pred_val=future_preds$yhat)
d<- melt(pred_df, id.vars = "hours")

ggplot(d, aes(x=hours, y=value, color=variable)) + 
  geom_point(size=1) + 
  geom_line()
```

Checking smape for our model

```{r}
smape(test$Zone.1.Power.Consumption, future_preds$yhat)
```

#### Yearly

```{r}
m <- prophet(history, daily.seasonality = F, weekly.seasonality = F, yearly.seasonality=TRUE )
```

Here we will make predictions for 2017 December

Plotting the predictions

```{r}
future = make_future_dataframe(m, periods = 4320, freq = 600)
forecast = predict(m, future)
plot(m, forecast, type="l")
```

```{r}
pred_df <- data.frame(hours=test$DateTime, test_val=test$Zone.1.Power.Consumption, pred_val=future_preds$yhat)
d<- melt(pred_df, id.vars = "hours")

ggplot(d, aes(x=hours, y=value, color=variable)) + 
  geom_point(size=1) + 
  geom_line()
```

```{r}
future_preds <- tail(forecast, 4320)
```

Checking smape for our model

```{r}
smape(test$Zone.1.Power.Consumption, future_preds$yhat)
```

### Modifying the number of change-points to improve model performance for daily model

```{r}
m3 <- prophet(history, daily.seasonality = T, n.changepoints = 6, changepoint.prior.scale = 0.1)

future = make_future_dataframe(m, periods = 4320, freq = 600)
forecast = predict(m3, future)
plot(m3, forecast, type="l") + add_changepoints_to_plot(m3)
```

```{r}
future_preds <- tail(forecast, 4320)
head(future_preds)
tail(future_preds)
```

```{r}
pred_df <- data.frame(hours=test$DateTime, test_val=test$Zone.1.Power.Consumption, pred_val=future_preds$yhat)
d<- melt(pred_df, id.vars = "hours")

ggplot(d, aes(x=hours, y=value, color=variable)) + 
  geom_point(size=1) + 
  geom_line()
```

Checking smape for improved model

```{r}
smape(test$Zone.1.Power.Consumption, future_preds$yhat)
```
